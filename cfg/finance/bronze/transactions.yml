layer: bronze
compute:
  engine: spark
  spark:
    app_name: "bronze_fin_transactions"
    options:
      spark.sql.session.timeZone: "UTC"
io:
  source:
    type: files
    path: "s3://datalake/raw/finance/transactions/"
    format: parquet
  sink:
    type: files
    format: parquet
    path: "s3://datalake/bronze/finance/transactions/"
transform:
  sql: |
    WITH base AS (
      SELECT
        CAST(transaction_id AS STRING) AS transaction_id,
        CAST(amount AS DECIMAL(18,2)) AS amount,
        UPPER(currency) AS currency,
        to_timestamp(updated_at) AS updated_at,
        to_date(posted_at) AS posted_date,
        *
      FROM __INPUT__
    )
    SELECT * FROM (
      SELECT *,
        ROW_NUMBER() OVER (PARTITION BY transaction_id ORDER BY updated_at DESC) AS rn
      FROM base
    ) WHERE rn = 1
dq:
  expectations:
    - type: unique
      column: transaction_id
    - type: range
      column: amount
      min: -100000000
      max: 100000000
