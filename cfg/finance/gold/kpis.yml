layer: gold
compute:
  engine: spark
  spark:
    app_name: "gold_fin_kpis"
    options:
      spark.sql.session.timeZone: "UTC"
io:
  source:
    type: files
    path: "s3://datalake/silver/finance/fact_transactions/"
    format: parquet
  sink:
    type: files
    format: parquet
    path: "s3://datalake/gold/finance/kpis/"
transform:
  sql: |
    SELECT
      posted_date,
      currency,
      SUM(amount) AS total_amount,
      SUM(CASE WHEN is_reversal = 1 THEN amount ELSE 0 END) AS total_reversals
    FROM __INPUT__
    GROUP BY posted_date, currency
dq:
  expectations:
    - type: not_null
      column: posted_date
