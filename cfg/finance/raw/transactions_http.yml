layer: raw
compute:
  engine: spark
  spark:
    app_name: "raw_fin_transactions_http"
    options:
      spark.sql.session.timeZone: "UTC"
io:
  source:
    type: http
    url: "https://api.finbank.com/v1/transactions"
    method: GET
    headers:
      Accept: "application/json"
    auth:
      type: bearer_env
      env: FINBANK_TOKEN
    pagination:
      strategy: param_increment
      param: page
      max_pages: 2000
    rate_limit:
      requests_per_minute: 60
    incremental:
      watermark:
        field: updated_at
        state_id: raw_fin_transactions_http
        default: "1970-01-01T00:00:00Z"
  sink:
    type: files
    format: parquet
    path: "s3://datalake/raw/finance/transactions/date={{ds}}/"
transform:
  pre:
    - rename:
        from: txn_id
        to: transaction_id
dq:
  expectations:
    - type: not_null
      column: transaction_id
    - type: valid_values
      column: currency
      values: ["USD", "EUR", "COP"]
