layer: gold
environment: production
platform:
  name: gcp
  compute:
    spark:
      app_name: "gold_fin_kpis"
storage:
  dataset_config: config/datasets/finanzas/payments_v3/dataset.yml
  environment_config: config/env.gcp.prod.yml
  source:
    type: files
    path: "gs://finance-prod/silver/fact_transactions/"
    format: parquet
  sink:
    type: files
    path: "gs://finance-prod/gold/kpis/"
    format: parquet
transformations:
  sql: |
    SELECT
      posted_date,
      currency,
      SUM(amount) AS total_amount,
      SUM(CASE WHEN is_reversal = 1 THEN amount ELSE 0 END) AS total_reversals
    FROM __INPUT__
    GROUP BY posted_date, currency
quality:
  expectations:
    - type: not_null
      column: posted_date
lineage:
  dataset: finance.transactions.gold
